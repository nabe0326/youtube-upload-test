name: YouTube Video Upload

on:
  # Triggered by Dify or external services
  repository_dispatch:
    types: [upload-video]

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      video_url:
        description: 'Video URL (Cloudinary)'
        required: true
        type: string
      title:
        description: 'Video title'
        required: true
        type: string
      description:
        description: 'Video description'
        required: false
        type: string
        default: ''
      tags:
        description: 'Tags (comma-separated)'
        required: false
        type: string
        default: ''
      category_id:
        description: 'Category ID (default: 22)'
        required: false
        type: string
        default: '22'
      privacy:
        description: 'Privacy status'
        required: false
        type: choice
        options:
          - private
          - public
          - unlisted
        default: 'private'
      callback_url:
        description: 'Callback URL (optional)'
        required: false
        type: string
        default: ''
      unique_id:
        description: 'Unique ID for tracking (optional)'
        required: false
        type: string
        default: ''

jobs:
  upload:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
          cache: 'pip'

      - name: Install dependencies
        run: |
          pip install -r requirements.txt

      - name: Parse input parameters
        id: params
        run: |
          if [ "${{ github.event_name }}" = "repository_dispatch" ]; then
            echo "video_url=${{ github.event.client_payload.video_url }}" >> $GITHUB_OUTPUT
            echo "title=${{ github.event.client_payload.title }}" >> $GITHUB_OUTPUT
            echo "description=${{ github.event.client_payload.description }}" >> $GITHUB_OUTPUT
            echo "tags=${{ github.event.client_payload.tags }}" >> $GITHUB_OUTPUT
            echo "category_id=${{ github.event.client_payload.category_id || '22' }}" >> $GITHUB_OUTPUT
            echo "privacy=${{ github.event.client_payload.privacy || 'private' }}" >> $GITHUB_OUTPUT
            echo "callback_url=${{ github.event.client_payload.callback_url }}" >> $GITHUB_OUTPUT
            UNIQUE_ID="${{ github.event.client_payload.unique_id }}"
          else
            echo "video_url=${{ inputs.video_url }}" >> $GITHUB_OUTPUT
            echo "title=${{ inputs.title }}" >> $GITHUB_OUTPUT
            echo "description=${{ inputs.description }}" >> $GITHUB_OUTPUT
            echo "tags=${{ inputs.tags }}" >> $GITHUB_OUTPUT
            echo "category_id=${{ inputs.category_id }}" >> $GITHUB_OUTPUT
            echo "privacy=${{ inputs.privacy }}" >> $GITHUB_OUTPUT
            echo "callback_url=${{ inputs.callback_url }}" >> $GITHUB_OUTPUT
            UNIQUE_ID="${{ inputs.unique_id }}"
          fi

          # Use github.run_id if unique_id is not provided
          if [ -z "$UNIQUE_ID" ]; then
            UNIQUE_ID="${{ github.run_id }}"
          fi
          echo "unique_id=$UNIQUE_ID" >> $GITHUB_OUTPUT

      - name: Upload video to YouTube
        id: upload
        env:
          YOUTUBE_CLIENT_ID: ${{ secrets.YOUTUBE_CLIENT_ID }}
          YOUTUBE_CLIENT_SECRET: ${{ secrets.YOUTUBE_CLIENT_SECRET }}
          YOUTUBE_REFRESH_TOKEN: ${{ secrets.YOUTUBE_REFRESH_TOKEN }}
        run: |
          set +e  # Don't exit on error, we want to capture the result

          python src/upload_youtube.py \
            --video-url "${{ steps.params.outputs.video_url }}" \
            --title "${{ steps.params.outputs.title }}" \
            --description "${{ steps.params.outputs.description }}" \
            --tags "${{ steps.params.outputs.tags }}" \
            --category-id "${{ steps.params.outputs.category_id }}" \
            --privacy "${{ steps.params.outputs.privacy }}" \
            > upload_result.json 2> upload_error.log

          UPLOAD_EXIT_CODE=$?
          echo "exit_code=$UPLOAD_EXIT_CODE" >> $GITHUB_OUTPUT

          if [ $UPLOAD_EXIT_CODE -eq 0 ]; then
            echo "success=true" >> $GITHUB_OUTPUT
            # Extract video_id and video_url from JSON result
            VIDEO_ID=$(cat upload_result.json | grep -o '"video_id": "[^"]*"' | cut -d'"' -f4)
            VIDEO_URL=$(cat upload_result.json | grep -o '"video_url": "[^"]*"' | cut -d'"' -f4)
            echo "video_id=$VIDEO_ID" >> $GITHUB_OUTPUT
            echo "video_url=$VIDEO_URL" >> $GITHUB_OUTPUT
          else
            echo "success=false" >> $GITHUB_OUTPUT
            # Capture error message
            ERROR_MSG=$(cat upload_error.log | tail -n 10)
            echo "error<<EOF" >> $GITHUB_OUTPUT
            echo "$ERROR_MSG" >> $GITHUB_OUTPUT
            echo "EOF" >> $GITHUB_OUTPUT
          fi

          exit $UPLOAD_EXIT_CODE

      - name: Save result to Gist
        id: save_result
        if: always()
        env:
          GIST_TOKEN: ${{ secrets.GIST_PAT }}
          RESULTS_GIST_ID: ${{ secrets.RESULTS_GIST_ID }}
        run: |
          UNIQUE_ID="${{ steps.params.outputs.unique_id }}"
          TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
          TIMESTAMP_UNIX=$(date +%s)

          if [ "${{ steps.upload.outputs.success }}" = "true" ]; then
            RESULT_JSON=$(cat <<EOF
          {
            "success": true,
            "video_id": "${{ steps.upload.outputs.video_id }}",
            "video_url": "${{ steps.upload.outputs.video_url }}",
            "title": "${{ steps.params.outputs.title }}",
            "unique_id": "$UNIQUE_ID",
            "timestamp": "$TIMESTAMP",
            "message": "Video uploaded successfully"
          }
          EOF
          )
          else
            ERROR_MSG=$(echo '${{ steps.upload.outputs.error }}' | jq -Rs .)
            RESULT_JSON=$(cat <<EOF
          {
            "success": false,
            "error": $ERROR_MSG,
            "title": "${{ steps.params.outputs.title }}",
            "unique_id": "$UNIQUE_ID",
            "timestamp": "$TIMESTAMP",
            "message": "Video upload failed"
          }
          EOF
          )
          fi

          # Get existing Gist to check for old files
          GIST_DATA=$(curl -s -H "Authorization: token $GIST_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            https://api.github.com/gists/$RESULTS_GIST_ID)

          # Build update payload with new file
          UPDATE_PAYLOAD=$(jq -n \
            --arg content "$RESULT_JSON" \
            --arg filename "youtube-upload-$UNIQUE_ID.json" \
            '{
              files: {
                ($filename): {
                  content: $content
                }
              }
            }')

          # Check for old files (>24 hours) and mark them for deletion
          CUTOFF_TIME=$((TIMESTAMP_UNIX - 86400))
          OLD_FILES=$(echo "$GIST_DATA" | jq -r '.files | keys[]' | grep "^youtube-upload-" || true)

          for file in $OLD_FILES; do
            # Extract timestamp from existing file if it has one
            FILE_CONTENT=$(echo "$GIST_DATA" | jq -r ".files[\"$file\"].content")
            FILE_TIMESTAMP=$(echo "$FILE_CONTENT" | jq -r '.timestamp // empty' 2>/dev/null || echo "")

            if [ -n "$FILE_TIMESTAMP" ]; then
              FILE_TIMESTAMP_UNIX=$(date -d "$FILE_TIMESTAMP" +%s 2>/dev/null || echo "0")
              if [ "$FILE_TIMESTAMP_UNIX" -lt "$CUTOFF_TIME" ]; then
                echo "Marking old file for deletion: $file"
                UPDATE_PAYLOAD=$(echo "$UPDATE_PAYLOAD" | jq --arg file "$file" '.files[$file] = null')
              fi
            fi
          done

          # Update Gist with new file and remove old ones
          GIST_RESPONSE=$(curl -s -X PATCH https://api.github.com/gists/$RESULTS_GIST_ID \
            -H "Authorization: token $GIST_TOKEN" \
            -H "Accept: application/vnd.github.v3+json" \
            -d "$UPDATE_PAYLOAD")

          GIST_URL=$(echo "$GIST_RESPONSE" | jq -r '.html_url')

          echo "âœ“ Result saved to Gist"
          echo "  Gist ID: $RESULTS_GIST_ID"
          echo "  Gist URL: $GIST_URL"
          echo "  Unique ID: $UNIQUE_ID"
          echo "  File: youtube-upload-$UNIQUE_ID.json"
          echo "gist_id=$RESULTS_GIST_ID" >> $GITHUB_OUTPUT
          echo "gist_url=$GIST_URL" >> $GITHUB_OUTPUT

      - name: Send callback to Dify
        if: always() && steps.params.outputs.callback_url != ''
        run: |
          CALLBACK_URL="${{ steps.params.outputs.callback_url }}"

          if [ "${{ steps.upload.outputs.success }}" = "true" ]; then
            # Success case
            curl -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -d '{
                "success": true,
                "video_id": "${{ steps.upload.outputs.video_id }}",
                "video_url": "${{ steps.upload.outputs.video_url }}",
                "title": "${{ steps.params.outputs.title }}",
                "unique_id": "${{ steps.params.outputs.unique_id }}",
                "message": "Video uploaded successfully"
              }'
          else
            # Error case
            curl -X POST "$CALLBACK_URL" \
              -H "Content-Type: application/json" \
              -d '{
                "success": false,
                "error": "${{ steps.upload.outputs.error }}",
                "title": "${{ steps.params.outputs.title }}",
                "unique_id": "${{ steps.params.outputs.unique_id }}",
                "message": "Video upload failed"
              }'
          fi

          echo "Callback sent to: $CALLBACK_URL"

      - name: Upload result summary
        if: always()
        run: |
          echo "## Upload Result" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          if [ "${{ steps.upload.outputs.success }}" = "true" ]; then
            echo "âœ… **Success**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Video ID**: ${{ steps.upload.outputs.video_id }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Video URL**: ${{ steps.upload.outputs.video_url }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Title**: ${{ steps.params.outputs.title }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "âŒ **Failed**" >> $GITHUB_STEP_SUMMARY
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "- **Title**: ${{ steps.params.outputs.title }}" >> $GITHUB_STEP_SUMMARY
            echo "- **Error**: See logs for details" >> $GITHUB_STEP_SUMMARY
          fi

          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "**Tracking Info:**" >> $GITHUB_STEP_SUMMARY
          echo "- **Unique ID**: ${{ steps.params.outputs.unique_id }}" >> $GITHUB_STEP_SUMMARY
          echo "- **Gist URL**: ${{ steps.save_result.outputs.gist_url }}" >> $GITHUB_STEP_SUMMARY

          if [ "${{ steps.params.outputs.callback_url }}" != "" ]; then
            echo "" >> $GITHUB_STEP_SUMMARY
            echo "ðŸ“¡ Callback sent to Dify" >> $GITHUB_STEP_SUMMARY
          fi
